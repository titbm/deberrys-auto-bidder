# Контекст разработки - Auction Auto Bidder

## Цель проекта
Создать Chrome расширение для автоматических ставок на аукционе deberrys.xyz

## Требования
- Оценивать количество монет на странице
- Читать текущую ставку на аукционе
- Проверять статус аукциона (активен/завершён)
- Автоматически скрываться на завершённых аукционах
- Делать ставки начиная с текущей+1, затем текущей+2, текущей+3... (с увеличением на 1)
- При успехе - увеличить ставку, ждать 30 секунд, продолжить
- При ошибке - показать ошибку 3 секунды, повторить с той же ставкой после паузы 3 секунды
- Продолжать пока хватает монет
- Кнопка запуска/остановки в правом нижнем углу
- Статус-бокс с последними 5 действиями над кнопкой
- Ожидание полной загрузки страницы перед стартом
- Блокировка старта если баланс = "?" или текущая ставка = "Encrypted"
- Shadow DOM для изоляции UI от стилей сайта

## Структура HTML элементов на странице

### Текущая ставка на аукционе
```html
<div class="flex items-center gap-2">
  <span class="text-2xl text-white font-medium">9</span>
  <span data-sentry-component="Berry">...</span>
</div>
```
**Селектор:** `span.text-2xl.text-white.font-medium` (рядом с `[data-sentry-component="Berry"]`)
**Примечание:** Ищем все элементы с этими классами и проверяем, что рядом есть Berry символ

**Невалидное значение (Encrypted):**
```html
<span class="text-2xl text-white font-medium">Encrypted</span>
```
При обнаружении "Encrypted" - блокируем старт и показываем ошибку

### Баланс монет
```html
<div class="flex items-center gap-1 text-white" 
     data-sentry-component="BalanceDisplay" 
     data-sentry-source-file="balance-display.tsx">
  <span>100</span>
  <span data-sentry-component="Berry">...</span>
</div>
```
**Селектор:** `[data-sentry-component="BalanceDisplay"] span:first-child`

**Невалидное значение (?):**
```html
<span>?</span>
```
При обнаружении "?" - блокируем старт и показываем ошибку

### Кнопка открытия модального окна
```html
<button class="..." 
        data-sentry-element="Button" 
        data-sentry-source-file="place-a-bid.tsx">
  <span class="flex items-center justify-center gap-2">
    Place a Bid
    <svg>...</svg>
  </span>
</button>
```
**Селектор:** `button[data-sentry-source-file="place-a-bid.tsx"]` ✅ ПРОВЕРЕН

### Поле ввода ставки
```html
<input id="input-h8onxtjjl" 
       data-slot="input" 
       class="..." 
       placeholder="0" 
       type="text" 
       value="">
```
**Селектор:** `[role="dialog"] input[type="text"]` ✅ ПРОВЕРЕН (улучшен - более надежный)
**Примечание:** ID динамический, поэтому используем селектор по типу внутри диалога

### Кнопка отправки ставки
```html
<button class="..." 
        type="submit">
  <span class="flex items-center justify-center gap-2">
    Place a Bid
    <svg>...</svg>
  </span>
</button>
```
**Селектор:** `[role="dialog"] button[type="submit"]` ✅ ПРОВЕРЕН
**Примечание:** Текст кнопки меняется: "Place a Bid" → "Encrypting bid..." → "Placing bid..." → "Done!"

### Сообщение об успехе
```html
<p>
  You successfully bid on this item. You'll be notified as soon as the auction closes.
</p>
```
**Селектор:** `Array.from(document.querySelectorAll('[role="dialog"] p')).find(p => p.textContent.includes('successfully bid'))` ✅ ПРОВЕРЕН

### Сообщение об ошибке
```html
<div class="text-red-500">Relayer didn't response correctly</div>
```
**Селектор:** `[role="dialog"] .text-red-500` ✅ ПРОВЕРЕН
**Примечание:** Также проверяем текст элементов на наличие ключевых слов: "no berries available", "relayer", "bad json", "didn't response", "error", "failed", "insufficient", "not enough", "try again"

### Закрытие модального окна
**Метод:** ESC key (самый надежный)
```javascript
document.dispatchEvent(new KeyboardEvent('keydown', { key: 'Escape', keyCode: 27, bubbles: true }));
```

## Архитектура расширения

### Файлы
1. **manifest.json** - конфигурация расширения
2. **content.js** - основной скрипт, внедряемый на страницу
3. **styles.css** - стили для UI элементов
4. **README.md** - документация для пользователя
5. **DEVELOPMENT.md** - этот файл, контекст для разработчика

### Класс AutoBidder

#### Свойства:
- `isRunning` - флаг активности автоставок
- `currentBid` - текущая ставка для размещения
- `balance` - текущий баланс монет
- `button` - ссылка на кнопку управления
- `statusBox` - ссылка на блок статуса
- `container` - контейнер для UI элементов
- `logEntries` - массив логов
- `statusLines` - массив последних 5 статусных сообщений
- `isReady` - флаг готовности (данные загружены)
- `wasRunning` - флаг для отслеживания состояния перед перезагрузкой

#### Методы:

**init()** - инициализация расширения
- Создает UI с Shadow DOM
- Логирует старт
- Проверяет флаг перезагрузки страницы
- Запускает ожидание загрузки данных

**createUI()** - создание UI с Shadow DOM
- Создает host элемент с максимальным z-index
- Создает Shadow DOM для изоляции стилей
- Добавляет стили в shadow root
- Создает контейнер, статус-бокс и кнопку
- Добавляет обработчик клика
- Добавляет в DOM

**waitForPageReady()** - ожидание загрузки данных
- Ждёт 2 секунды для загрузки страницы
- Проверяет статус аукциона (ищет "Auction Complete")
- Если аукцион завершён: показывает сообщение на 5 секунд, затем полностью скрывает UI
- Если аукцион активен: проверяет баланс и текущую ставку каждые 500мс
- Максимум 30 секунд ожидания (60 попыток)
- Если обнаружен "?" в балансе или "Encrypted" в ставке - показывает ошибку и блокирует старт
- Когда оба значения валидны - активирует кнопку
- При таймауте - показывает ошибку

**log(message)** - логирование
- Добавляет timestamp
- Выводит в console с префиксом [AutoBidder]
- Сохраняет в массив

**updateStatus(message, type)** - обновление статуса
- Логирует сообщение
- Добавляет в массив statusLines с временем и типом
- Оставляет только последние 5 строк
- Вызывает renderStatus()

**renderStatus()** - отрисовка статус-бокса
- Генерирует HTML для последних 5 статусных сообщений
- Применяет цветовую кодировку (зеленый для success, красный для error)
- Обрезает длинные сообщения до 80 символов
- Показывает статус-бокс если есть сообщения

**updateBalance()** - обновление баланса
- Находит элемент с балансом
- Проверяет на "?" - если да, показывает ошибку и возвращает false
- Парсит число
- Обновляет статус
- Возвращает true/false

**getCurrentBid()** - получение текущей ставки
- Находит все элементы span.text-2xl.text-white.font-medium
- Проверяет на "Encrypted" - если да, показывает ошибку и возвращает null
- Для каждого элемента проверяет, что рядом есть Berry символ
- Парсит значение текущей ставки
- Обновляет статус
- Возвращает число или null

**start()** - запуск автоставок
- Проверяет isReady флаг
- Обновляет баланс
- Получает текущую ставку
- Начинает со следующей ставки (текущая + 1)
- Устанавливает флаги и обновляет UI
- Запускает цикл ставок

**stop()** - остановка автоставок
- Обновляет статус
- Сбрасывает флаги
- Обновляет UI

**bidLoop()** - основной цикл ставок
- Обновляет баланс перед каждой ставкой
- Получает текущую ставку
- Проверяет на "?" или "Encrypted" - если обнаружено, останавливается с предупреждением
- Проверяет достаточность монет
- Вызывает placeBid()
- При успехе: увеличивает ставку, ждет 30 секунд, продолжает
- При ошибке: показывает ошибку, пауза уже была в placeBid (3 сек показа + 3 сек перед повтором)

**placeBid(amount)** - размещение одной ставки
1. Обновляет статус "Открываю окно ставки..."
2. Находит и кликает кнопку открытия модального окна
3. Ждет 1000мс
4. Обновляет статус "Ввожу ставку: X"
5. Находит поле ввода
6. Очищает и вводит значение ставки
7. Триггерит события для React (input, change)
8. Ждет 500мс
9. Обновляет статус "Отправляю ставку..."
10. Находит и кликает кнопку submit
11. Обновляет статус "Жду результата..."
12. Вызывает waitForBidResult() - ждет до 10 минут
13. При успехе: обновляет статус "Ставка принята!", закрывает модальное окно, возвращает true
14. При ошибке: обновляет статус с текстом ошибки, ждет 3 секунды (чтобы увидеть ошибку), закрывает модальное окно, возвращает false

**waitForBidResult()** - ожидание результата ставки
- Максимум 10 минут ожидания (600 секунд)
- Проверяет каждые 500мс
- Ищет сообщение об успехе: элемент p с текстом "successfully bid"
- Ищет сообщение об ошибке:
  - Сначала проверяет .text-red-500 (самый точный индикатор)
  - Затем ищет в других элементах ключевые слова ошибок
- Проверяет, не закрылось ли модальное окно (признак ошибки)
- Возвращает { success: true/false, error: "текст ошибки" }

**closeModal()** - закрытие модального окна
- Обновляет статус "Закрываю окно..."
- Отправляет ESC key (самый надежный способ)
- Ждет 500мс
- Проверяет, закрылось ли окно
- Если нет - ищет кнопку закрытия и кликает

**sleep(ms)** - задержка
- Promise-based таймер

**log(message)** - логирование
- Добавляет timestamp
- Выводит в console
- Сохраняет в массив

## Особенности реализации

### Проверка статуса аукциона
Расширение проверяет, не завершён ли аукцион перед началом работы:
```javascript
const checkAuctionStatus = () => {
  return Array.from(document.querySelectorAll('*')).find(el => 
    el.textContent.trim() === 'Auction Complete'
  );
};
```
Если аукцион завершён - показывает сообщение на 5 секунд, затем полностью скрывает UI.

### Проверка URL страницы
Расширение проверяет URL и не запускается на странице списка аукционов:
```javascript
const path = window.location.pathname;
if (path === '/auctions' || path === '/auctions/') {
  return; // Не запускаем на списке аукционов
}
```
Работает только на страницах конкретных аукционов типа `/auctions/the-zama-og-nft-ii-53`.

### Shadow DOM для изоляции UI
Используется Shadow DOM для полной изоляции UI элементов от стилей сайта:
```javascript
const host = document.createElement('div');
host.style.cssText = 'position: fixed !important; z-index: 2147483647 !important;';
const shadow = host.attachShadow({ mode: 'open' });
// Добавляем стили и элементы в shadow root
```
Это решает проблему с z-index, когда UI элементы рендерились под контентом сайта.

### Проверка валидности данных
Перед стартом и во время работы проверяем:
- Баланс не должен быть "?" (означает, что данные не загружены)
- Текущая ставка не должна быть "Encrypted" (означает, что данные не расшифрованы)

При обнаружении невалидных данных:
- На старте: блокируем кнопку, показываем ошибку
- Во время работы: останавливаем автоставки, показываем предупреждение

### Форматирование времени
Используется прямое получение компонентов времени вместо `toLocaleTimeString()`:
```javascript
const now = new Date();
const hours = String(now.getHours()).padStart(2, '0');
const minutes = String(now.getMinutes()).padStart(2, '0');
const seconds = String(now.getSeconds()).padStart(2, '0');
const timestamp = `${hours}:${minutes}:${seconds}`;
```
Это гарантирует корректное отображение локального времени системы.

### Поддержка нулевой ставки
Проверка изменена с `value > 0` на `value >= 0`, чтобы поддерживать ставки от 0:
```javascript
if (!isNaN(value) && value >= 0) {
  // Обрабатываем ставку
}
```

### Отсутствие алертов
Все уведомления отображаются только в статус-боксе, алерты не используются для лучшего UX.

### React события
Для корректной работы с React-формами нужно триггерить события:
```javascript
const inputEvent = new Event('input', { bubbles: true });
const changeEvent = new Event('change', { bubbles: true });
input.dispatchEvent(inputEvent);
input.dispatchEvent(changeEvent);
```

### Динамические ID
ID поля ввода генерируется динамически (например: input-h8onxtjjl), поэтому используем более надежный селектор:
```javascript
[role="dialog"] input[type="text"]  // ищем внутри диалога по типу
```

### Задержки (финальные, после тестирования)
- **1000мс** после открытия модального окна (ждем полной загрузки формы)
- **500мс** после ввода значения (даем React обработать изменения)
- **До 10 минут** ожидание результата ставки (шифрование + отправка в блокчейн)
- **3 секунды** показ ошибки перед закрытием модального окна
- **30 секунд** пауза после успешной ставки перед следующей
- **3 секунды** пауза после ошибки перед повтором (уже включена в показ ошибки)
- **500мс** после закрытия модального окна
- **500мс** интервал проверки при ожидании загрузки данных
- **30 секунд** максимум ожидания загрузки данных при инициализации

**Важно:** Процесс размещения ставки включает:
1. Шифрование ставки (FHE encryption) - может занять 5-10 секунд
2. Отправка в блокчейн - еще 5-10 секунд
3. Подтверждение транзакции

### Проверка успеха и ошибок
**Успех:** Ищем элемент `p` внутри `[role="dialog"]` и проверяем, содержит ли он текст "successfully bid"

**Ошибки:** 
1. Сначала проверяем `.text-red-500` (самый точный индикатор)
2. Затем ищем в других элементах ключевые слова: "no berries available", "relayer", "bad json", "didn't response", "error", "failed", "insufficient", "not enough", "try again"
3. Проверяем, не закрылось ли модальное окно (может быть признаком ошибки)

**Обработка:**
- При успехе: сразу закрываем окно и переходим к следующей ставке
- При ошибке: показываем ошибку 3 секунды, закрываем окно, повторяем с той же ставкой

## Тестирование

### Результаты тестирования (25.12.2024):
1. ✅ Селекторы проверены на реальной странице
2. ✅ Баланс читается корректно (включая 0)
3. ✅ Текущая ставка читается корректно (включая 0)
4. ✅ Модальное окно открывается
5. ✅ Значение вводится в поле
6. ✅ Форма отправляется
7. ✅ Процесс шифрования работает (Encrypting bid → Placing bid)
8. ✅ Сообщение об успехе детектируется
9. ✅ Сообщения об ошибках детектируются (.text-red-500)
10. ✅ Модальное окно закрывается (ESC)
11. ✅ Проверка на "?" в балансе работает
12. ✅ Проверка на "Encrypted" в ставке работает
13. ✅ Статус-бокс отображается с последними 5 действиями
14. ✅ Shadow DOM изолирует UI от стилей сайта
15. ✅ Паузы после ошибок работают (3 секунды)
16. ✅ Пауза после успешной ставки работает (30 секунд)
17. ✅ Поддержка нулевой ставки работает
18. ✅ Алерты удалены, вся информация в статус-боксе
19. ✅ Время форматируется корректно
20. ✅ Не запускается на странице списка аукционов
21. ✅ Определяет завершённые аукционы и скрывается

### Сценарии тестирования:
1. **Успешная ставка** - проверить весь цикл
2. **Недостаток монет** - проверить остановку
3. **Ошибка сервера** - проверить повтор
4. **Ручная остановка** - проверить кнопку

## Возможные улучшения
- [ ] Настройка начальной ставки
- [ ] Настройка шага увеличения
- [ ] Настройка максимальной ставки
- [ ] История ставок в UI с возможностью экспорта
- [ ] Звуковые уведомления при успехе/ошибке
- [ ] Статистика (всего ставок, потрачено монет, процент успеха)
- [ ] Настройка задержек через UI
- [ ] Popup с настройками расширения
- [ ] Автоматическое обновление страницы при обнаружении "?" или "Encrypted"
- [ ] Режим "умных ставок" (анализ конкурентов)

## Известные ограничения
- Работает только на deberrys.xyz/auctions/* (конкретные аукционы, не список)
- НЕ работает на странице списка аукционов /auctions
- Автоматически скрывается на завершённых аукционах
- Требует открытую вкладку браузера (расширение не работает в фоне)
- Зависит от структуры HTML (может сломаться при обновлении сайта)
- Нет обработки капчи или других защит
- Не работает если баланс показывает "?" или ставка показывает "Encrypted"
- Требует стабильное интернет-соединение для корректной работы
- Поддерживает ставки от 0 и выше

## Отладка

### Консоль браузера
Все логи выводятся с префиксом `[AutoBidder]`

### Проверка селекторов
```javascript
// В консоли браузера на странице аукциона:
document.querySelector('[data-sentry-component="BalanceDisplay"] span:first-child')
document.querySelector('button[data-sentry-source-file="place-a-bid.tsx"]')
document.querySelector('input[id^="input-"]')
document.querySelector('button[type="submit"]')
document.querySelector('p.text-sm')
```

### Типичные ошибки
1. **Элемент не найден** - селектор устарел, проверить HTML структуру на странице
2. **Значение не вводится** - не триггерятся React события (input, change)
3. **Модальное окно не закрывается** - ESC не работает, изменилась структура
4. **Баланс не обновляется** - изменился формат отображения или появился "?"
5. **Текущая ставка не читается** - изменилась структура или появился "Encrypted"
6. **UI элементы не видны** - проблема с Shadow DOM или z-index
7. **Ошибка "Relayer didn't response correctly"** - проблема на стороне сервера, расширение повторит попытку
8. **Автоставки остановились** - проверить консоль и статус-бокс для причины

## Версионирование
- v1.0 - Базовая функциональность
- v1.1 - Добавлена проверка текущей ставки, начало со следующей ставки
- v1.2 - Добавлен статус-бокс с последними 5 действиями
- v1.3 - Добавлена проверка на "?" и "Encrypted", блокировка старта
- v1.4 - Улучшена обработка ошибок, паузы после ошибок
- v1.5 - Реализован Shadow DOM для изоляции UI от стилей сайта
- v1.6 - Увеличено время ожидания результата до 10 минут, улучшена детекция ошибок
- v1.7 - Добавлена пауза 30 секунд после успешной ставки
- v1.8 - Исправлена поддержка нулевой ставки (value >= 0)
- v1.9 - Убрано двойное ожидание загрузки, удалены алерты
- v1.10 - Исправлено форматирование времени (прямые методы вместо toLocaleTimeString)
- v1.11 - Добавлена проверка URL (не запускается на странице списка аукционов)
- v1.12 - Добавлена проверка статуса аукциона (автоматически скрывается на завершённых)
